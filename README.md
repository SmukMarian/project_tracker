# Haier Project Tracker

Черновая заготовка backend-а и архитектурных заметок для локального приложения управления проектами.

## Текущий статус
- Основные требования ТЗ покрыты; готовность оценивается примерно в ~100%: есть диалоги CRUD, KPI/экспорты, тёмная тема, медиатека с загрузкой файлов в workspace, файловый лог backend/desktop и подготовленная сборка инсталлятора с автообновлением через манифест. Приложением можно пользоваться уже сейчас через локальный запуск или собранный установщик.

## Когда можно пользоваться
- **Прямо сейчас**: установите зависимости, запустите backend (`uvicorn backend.app:app --reload`) и SPA (`npm run dev` или сборка `npm run build` + отдача через backend/desktop). Все ключевые сценарии ТЗ доступны.
- **Установщик**: соберите через `python packaging/build_installer.py ...` (см. ниже). Перед развёртыванием рекомендуем прогнать смоук-тест (`--smoke-test`), чтобы убедиться в корректности манифеста/пакета.

## Быстрый старт backend
1. Установите зависимости: `pip install -r requirements.txt`.
2. Запустите сервер: `uvicorn backend.app:app --reload`.
3. Откройте http://localhost:8000/docs чтобы проверить доступные endpoint'ы.
4. Настройте workspace: `POST /workspace` принимает путь папки и создаёт её, `GET /workspace` возвращает текущий путь.
5. Если выполнена сборка фронтенда (`npm run build` в каталоге `frontend`), SPA автоматически отдаётся по адресу http://localhost:8000/app/.

> Рекомендация по версии Python: окружение тестировалось на Python 3.12, но если словите неожиданные ошибки зависимостей (FastAPI/uvicorn), установите Python 3.11 и пересоздайте venv.

## Предпросмотр frontend
1. Перейдите в директорию `frontend/`.
2. Установите зависимости: `npm install`.
3. Запустите dev-сервер: `npm run dev` и откройте указанный localhost-порт (по умолчанию 5173).
4. Для интеграции с desktop-обёрткой соберите проект: `npm run build` (артефакты попадут в `frontend/dist`).

SPA пытается загрузить данные с API (`VITE_API_BASE`, по умолчанию `http://localhost:8000`) и автоматически откатывается к мок-данным, если сервер недоступен. Макет сохраняет требуемую компоновку: верхнее меню, левая колонка категорий/проектов с фильтрами, карточка проекта и блок шагов/подзадач с табами. Верхнее меню умеет выбирать и сохранять workspace, экспортировать категории в Excel, собирать KPI-отчёт в отдельном модальном окне и открывать справочник PM. Кнопки карточки проекта запускают выгрузку Word для выбранной категории/проекта и презентации категории (PPTX) прямо из backend.

В интерфейсе доступен переключатель светлой/тёмной темы в верхнем меню; выбранная тема сохраняется в локальном хранилище браузера.

Поиск поддерживает токены вида `status:in_progress`, `owner:Имя`, `assignee:Имя`, `weight:>1` в левом списке и таблицах шагов/подзадач; `Ctrl+F` фокусирует поисковое поле проектов. Шаги и подзадачи создаются/удаляются с попыткой записи в API (с автоматическим откатом к локальному мок-контенту при недоступности сервера), а комментарии по шагу редактируются во вкладке «Детали».

Медиатека открывается из карточки проекта или панели шагов; загрузка файлов пишет их в подкаталог `media` внутри выбранного workspace и сразу сохраняет ссылку в базе. Список вложений можно удалить или открыть по полному пути.

Для хостинга обновлений backend предоставляет: `GET/POST /updates/manifest` (JSON-манифест версии/ссылки/описания и опционального `sha256` в `workspace/updates/manifest.json`), `POST /updates/package` для загрузки бинарника (в ответе возвращает рассчитанный SHA-256) и `GET /updates/download/{filename}` для его раздачи. Это позволяет использовать локальный сервер как источник обновлений для desktop-обёртки.

## Desktop-обёртка
1. Установите Python-зависимости (см. backend): `pip install -r requirements.txt`.
2. Соберите SPA (`npm run build`), чтобы фронтенд оказался в `frontend/dist`.
3. Запустите лаунчер: `python desktop.py`.
   - Backend поднимется на `http://127.0.0.1:8000` и откроется окно с `http://127.0.0.1:8000/app/`.
   - Если нужен внешний UI (например, dev-сервер Vite), укажите `--ui-url http://localhost:5173`.
   - Параметр `--no-backend` позволяет подключаться к уже запущенному серверу без автозапуска.
   - Параметр `--update-url` включает проверку обновлений по JSON-манифесту `{ "version": "0.1.1", "download_url": "..." }`; `--auto-open-download` автоматически откроет ссылку в браузере.
   - Логи desktop-обёртки и backend пишутся в подкаталог `logs/` внутри выбранного workspace.

## Сборка установщика (Windows)
1. Установите дополнительную зависимость PyInstaller: `pip install pyinstaller` (и по желанию NSIS для полноценного setup.exe).
2. Соберите SPA (`npm run build`).
3. Выполните `python packaging/build_installer.py --version 0.1.0 --with-nsis --workspace <путь к workspace>` из корня репозитория.
   - В `dist/` появится `haier-project-tracker.exe`; при наличии `makensis` — `HaierProjectTracker-Setup-<версия>.exe` по скрипту `packaging/installer.nsi`.
   - При переданном `--workspace` артефакты копируются в `<workspace>/updates/`, туда же пишется `manifest.json` с `version`, `download_url` (по умолчанию `http://127.0.0.1:8000/updates/download/<файл>`) и `sha256`. Опциональный `--notes` добавляет release notes.
   - Флаг `--smoke-test` прогоняет валидацию манифеста через `packaging/test_update_flow.py` сразу после сборки; добавьте `--smoke-test-download`, если backend уже отдаёт `manifest.json` и файл по ссылке из `download_url` и нужно проверить загрузку/хэш. При необходимости укажите `--smoke-test-url` (например, `file:///.../workspace/updates/manifest.json`).

## Смоук-тест обновлений
- Запустите backend (`uvicorn backend.app:app --reload`) и убедитесь, что workspace выбран.
- Проверьте раздачу манифеста и пакета одной командой:
  - `python packaging/test_update_flow.py --manifest-url http://127.0.0.1:8000/updates/manifest --expected-version 0.1.0 --expected-sha256 <sha из upload-пакета или manifest>`
- Скрипт валидирует JSON-манифест, при необходимости предупреждает о некорректном `Content-Type`, сравнивает ожидаемую версию, скачивает файл из `download_url`, проверяет, что размер не нулевой, и сверяет SHA-256 с указанным значением (из аргумента или из `manifest.sha256`).

## Структура
- `backend/` — FastAPI + SQLAlchemy схема данных, базовые endpoint'ы и расчёт прогресса.
- `docs/` — архитектурные заметки по проекту.

## Что дальше
- Прогонять смоук-тест обновления (`packaging/test_update_flow.py`) на собранном инсталляторе или использовать `packaging/build_installer.py --smoke-test` для автоматической проверки манифеста (и при наличии backend — скачивания файла).
